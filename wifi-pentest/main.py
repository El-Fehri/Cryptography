#!/usr/bin/env python3
"""
WiFi Penetration Testing Framework
Main Entry Point
Educational Purpose Only - For Classroom Use
"""

import sys
import subprocess
import os
import tkinter as tk
from tkinter import ttk, messagebox
import time

# Add the project root directory to Python path to ensure imports work
project_root = os.path.dirname(os.path.abspath(__file__))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

print("=" * 60)
print("WiFi Penetration Testing Framework")
print("=" * 60)
print(f"Python version: {sys.version}")
print(f"Project root: {project_root}")
print(f"Python path: {sys.path}")
print("=" * 60)

def check_permissions():
    """Check if we have necessary permissions for WiFi scanning"""
    try:
        # Try to run a simple iwlist command to check permissions
        result = subprocess.run(['iwlist', '--help'], capture_output=True)
        if result.returncode != 0:
            return False, "iwlist not found"
        
        # Check if we can run sudo (will be needed for scanning)
        result = subprocess.run(['sudo', '-n', 'true'], capture_output=True)
        if result.returncode != 0:
            return False, "sudo access required"
        
        return True, "OK"
    except Exception as e:
        return False, str(e)
    
def check_dependencies():
    """Check if required dependencies are installed"""
    missing = []
    
    # Check matplotlib
    try:
        import matplotlib
        print(f"✅ matplotlib version: {matplotlib.__version__}")
    except ImportError:
        missing.append('matplotlib')
        print("❌ matplotlib not found")
    
    # Check numpy
    try:
        import numpy
        print(f"✅ numpy version: {numpy.__version__}")
    except ImportError:
        missing.append('numpy')
        print("❌ numpy not found")
    
    # Check cryptography
    try:
        import cryptography
        print(f"✅ cryptography version: {cryptography.__version__}")
    except ImportError:
        missing.append('cryptography')
        print("❌ cryptography not found")
    
    # Check tkinter (should be built-in)
    try:
        import tkinter
        print(f"✅ tkinter found")
    except ImportError:
        missing.append('tkinter')
        print("❌ tkinter not found")
    
    if missing:
        print("\n" + "=" * 60)
        print("Missing dependencies:")
        for dep in missing:
            print(f"  - {dep}")
        print("\nInstall with: pip install " + ' '.join(missing))
        print("=" * 60)
        return False
    
    return True


def show_splash(root):
    """Show splash screen while loading"""
    splash = tk.Toplevel(root)
    splash.title("Loading...")
    splash.geometry("500x300")
    splash.overrideredirect(True)  # Remove window decorations
    
    # Center splash screen
    splash.update_idletasks()
    x = (splash.winfo_screenwidth() // 2) - (500 // 2)
    y = (splash.winfo_screenheight() // 2) - (300 // 2)
    splash.geometry(f'500x300+{x}+{y}')
    
    # Configure colors
    splash.configure(bg='#2b2b2b')
    
    # Splash content
    title_label = tk.Label(splash, text="WiFi Penetration Testing Framework", 
                          font=('Arial', 16, 'bold'), 
                          fg='#4CAF50', bg='#2b2b2b')
    title_label.pack(pady=40)
    
    version_label = tk.Label(splash, text="Version 1.0.0", 
                            font=('Arial', 10),
                            fg='#888888', bg='#2b2b2b')
    version_label.pack()
    
    warning_label = tk.Label(splash, text="⚠️  Educational Purpose Only  ⚠️", 
                            font=('Arial', 12, 'bold'),
                            fg='#ff9800', bg='#2b2b2b')
    warning_label.pack(pady=30)
    
    loading_label = tk.Label(splash, text="Loading modules...", 
                            font=('Arial', 10),
                            fg='#ffffff', bg='#2b2b2b')
    loading_label.pack(pady=10)
    
    # Create a canvas for custom progress bar
    canvas = tk.Canvas(splash, width=300, height=20, bg='#3c3f41', highlightthickness=0)
    canvas.pack(pady=20)
    
    # Draw progress bar fill (will be animated)
    progress_rect = canvas.create_rectangle(0, 0, 0, 20, fill='#4CAF50', width=0)
    
    def animate_progress(pos=0):
        if pos < 300 and splash.winfo_exists():
            canvas.coords(progress_rect, 0, 0, pos, 20)
            splash.after(20, lambda: animate_progress(pos + 2))
    
    # Start animation
    splash.after(100, animate_progress)
    
    return splash


def show_disclaimer(parent):
    """Show legal disclaimer dialog"""
    disclaimer = """⚠️ LEGAL DISCLAIMER ⚠️

This tool is for EDUCATIONAL PURPOSES ONLY.

Unauthorized access to computer networks is illegal. 
This tool should only be used:

✓ On networks you own
✓ On networks you have explicit written permission to test
✓ In educational environments under qualified supervision

The authors are NOT responsible for any misuse of this software.
Users are solely responsible for complying with all applicable laws.

By using this software, you acknowledge that you understand and agree to these terms."""
    
    return messagebox.askyesno("Legal Disclaimer", disclaimer + "\n\nDo you accept these terms?")


def test_imports():
    """Test imports of major modules"""
    print("\nTesting module imports...")
    
    modules_to_test = [
        ('gui.main_window', 'MainWindow'),
        ('scanners.network_scanner', 'NetworkScanner'),
        ('attacks.base_attack', 'AttackBase'),
        ('attacks.wep_attacks', 'WEPAttack'),
        ('attacks.wpa_attacks', 'WPAAttack'),
        ('attacks.deauth_attack', 'DeauthAttack'),
        ('core.rc4', 'RC4'),
        ('core.wep_core', 'WEPCore'),
        ('core.wpa_core', 'WPACore'),
    ]
    
    all_success = True
    
    for module_name, class_name in modules_to_test:
        try:
            module = __import__(module_name, fromlist=[class_name])
            cls = getattr(module, class_name)
            print(f"✅ {module_name}.{class_name}")
        except ImportError as e:
            print(f"❌ {module_name}.{class_name}: {e}")
            all_success = False
        except AttributeError as e:
            print(f"❌ {module_name}.{class_name}: Class not found - {e}")
            all_success = False
        except Exception as e:
            print(f"❌ {module_name}.{class_name}: Unexpected error - {e}")
            all_success = False
    
    return all_success


def create_minimal_gui():
    """Create a minimal GUI for testing when full GUI fails"""
    root = tk.Tk()
    root.title("WiFi Penetration Testing Framework - Minimal Test")
    root.geometry("800x600")
    
    # Configure style
    style = ttk.Style()
    style.theme_use('clam')
    
    # Create a simple interface
    main_frame = ttk.Frame(root, padding="10")
    main_frame.pack(fill=tk.BOTH, expand=True)
    
    # Title
    title_label = ttk.Label(main_frame, text="WiFi Penetration Testing Framework", 
                           font=('Arial', 16, 'bold'))
    title_label.pack(pady=20)
    
    # Status
    status_label = ttk.Label(main_frame, text="Status: Running in minimal mode", 
                            font=('Arial', 10))
    status_label.pack(pady=10)
    
    # Info text
    info_text = tk.Text(main_frame, height=15, width=80, bg='#2b2b2b', fg='#ffffff')
    info_text.pack(fill=tk.BOTH, expand=True, pady=10)
    
    scrollbar = ttk.Scrollbar(main_frame, orient=tk.VERTICAL, command=info_text.yview)
    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    info_text.configure(yscrollcommand=scrollbar.set)
    
    # Add information
    info_text.insert(tk.END, "WIFI PENETRATION TESTING FRAMEWORK\n")
    info_text.insert(tk.END, "=" * 50 + "\n\n")
    info_text.insert(tk.END, "Running in minimal mode because the full GUI could not be loaded.\n\n")
    info_text.insert(tk.END, "This typically happens due to:\n")
    info_text.insert(tk.END, "  • Missing dependencies\n")
    info_text.insert(tk.END, "  • Import errors in GUI modules\n")
    info_text.insert(tk.END, "  • Circular imports\n\n")
    info_text.insert(tk.END, "Please check the console output for error messages.\n\n")
    info_text.insert(tk.END, "To use the full GUI, fix the import errors shown in the terminal.\n")
    
    info_text.config(state='disabled')
    
    # Buttons
    button_frame = ttk.Frame(main_frame)
    button_frame.pack(pady=20)
    
    ttk.Button(button_frame, text="Retry Full GUI", 
              command=lambda: retry_full_gui(root)).pack(side=tk.LEFT, padx=5)
    
    ttk.Button(button_frame, text="Exit", 
              command=root.quit).pack(side=tk.LEFT, padx=5)
    
    return root


def retry_full_gui(current_root):
    """Attempt to reload the full GUI"""
    current_root.destroy()
    
    # Clear any cached imports
    for module in list(sys.modules.keys()):
        if module.startswith(('gui.', 'scanners.', 'attacks.', 'core.')):
            del sys.modules[module]
    
    # Restart the main function
    main()


def main():
    """Main entry point"""
    print("\nInitializing application...")
    
    # Check Python version
    if sys.version_info < (3, 6):
        print("❌ Python 3.6 or higher is required")
        print(f"Current version: {sys.version}")
        sys.exit(1)
    
    # Check dependencies
    if not check_dependencies():
        response = input("\nContinue anyway? (y/n): ")
        if response.lower() != 'y':
            sys.exit(1)

    # Check permissions for WiFi scanning
    perm_ok, perm_msg = check_permissions()
    if not perm_ok:
        print(f"⚠️ WiFi scanning may not work: {perm_msg}")
        print("You may need to:")
        print("  1. Install wireless-tools: sudo apt install wireless-tools")
        print("  2. Configure sudo without password for iwlist")
        print("  3. Or run the script with sudo")

    # Test imports first
    imports_success = test_imports()
    if not imports_success:
        print("\n⚠️ Some modules failed to import")
        print("This may be due to relative import errors or missing classes.")
        print("The application will attempt to run in minimal mode if you continue.")
        response = input("Continue anyway? (y/n): ")
        if response.lower() != 'y':
            sys.exit(1)
    
    # Create root window
    print("\nCreating main window...")
    root = tk.Tk()
    root.withdraw()  # Hide main window while loading
    
    # Show splash screen
    splash = show_splash(root)
    root.update()
    
    # Small delay to show splash
    time.sleep(1)
    
    # Show disclaimer
    if not show_disclaimer(root):
        print("User declined the disclaimer. Exiting.")
        splash.destroy()
        root.destroy()
        sys.exit(0)
    
    # Update splash
    root.update()
    
    # Try to import the full MainWindow
    print("\nLoading full GUI...")
    try:
        # Import MainWindow
        from gui.main_window import MainWindow
        print("✅ Full GUI modules loaded successfully")
        
        # Small delay before destroying splash
        time.sleep(0.5)
        
        # Destroy splash
        splash.destroy()
        
        # Show main window
        root.deiconify()
        
        # Create main application
        print("Creating MainWindow instance...")
        try:
            app = MainWindow(root)
            print("✅ MainWindow created successfully")
            
            # Update status
            root.update()
            
        except Exception as e:
            print(f"❌ Error creating MainWindow: {e}")
            import traceback
            traceback.print_exc()
            
            # Destroy splash if it still exists
            try:
                splash.destroy()
            except:
                pass
            
            # Show error message
            messagebox.showerror("Initialization Error", 
                                f"Failed to create main window:\n\n{str(e)}\n\n"
                                "The application will now run in minimal mode.")
            
            # Fall back to minimal GUI
            root.destroy()
            minimal_root = create_minimal_gui()
            minimal_root.mainloop()
            return
            
    except ImportError as e:
        print(f"❌ Error loading full GUI: {e}")
        import traceback
        traceback.print_exc()
        
        # Destroy splash
        try:
            splash.destroy()
        except:
            pass
        
        # Show error message
        messagebox.showerror("Import Error", 
                            f"Failed to import GUI modules:\n\n{str(e)}\n\n"
                            "This is likely due to relative import issues.\n"
                            "The application will now run in minimal mode.")
        
        # Fall back to minimal GUI
        root.destroy()
        minimal_root = create_minimal_gui()
        minimal_root.mainloop()
        return
        
    except Exception as e:
        print(f"❌ Unexpected error: {e}")
        traceback.print_exc()
        
        # Destroy splash
        try:
            splash.destroy()
        except:
            pass
        
        root.destroy()
        sys.exit(1)
    
    print("\n" + "=" * 60)
    print("Application ready!")
    print("=" * 60)
    
    # Start main loop
    try:
        root.mainloop()
    except KeyboardInterrupt:
        print("\nReceived keyboard interrupt. Exiting...")
    except Exception as e:
        print(f"\n❌ Error in main loop: {e}")
        traceback.print_exc()
    finally:
        print("\nApplication terminated.")
        sys.exit(0)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nApplication interrupted by user.")
        sys.exit(0)
    except Exception as e:
        print(f"\n❌ Fatal error: {e}")
        import traceback
        traceback.print_exc()
        
        # Try to show error in GUI if possible
        try:
            root = tk.Tk()
            root.withdraw()
            messagebox.showerror("Fatal Error", 
                                f"An unexpected error occurred:\n\n{str(e)}\n\n"
                                "Check the console for details.")
            root.destroy()
        except:
            pass
        
        sys.exit(1)