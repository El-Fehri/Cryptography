"""
File Operations Utility Module
"""

import json
import os
import pickle
from datetime import datetime


def save_session(filename, session_data):
    """
    Save session data to file
    
    Args:
        filename: Output filename
        session_data: Dictionary with session data
        
    Returns:
        bool: True if successful
    """
    try:
        # Add metadata
        session_data['saved'] = datetime.now().isoformat()
        
        # Determine format by extension
        if filename.endswith('.json'):
            with open(filename, 'w') as f:
                json.dump(session_data, f, indent=2, default=str)
        elif filename.endswith('.pkl'):
            with open(filename, 'wb') as f:
                pickle.dump(session_data, f)
        else:
            # Default to JSON
            with open(filename + '.json', 'w') as f:
                json.dump(session_data, f, indent=2, default=str)
                
        return True
    except Exception as e:
        print(f"Error saving session: {e}")
        return False


def load_session(filename):
    """
    Load session data from file
    
    Args:
        filename: Input filename
        
    Returns:
        dict: Session data or None if error
    """
    try:
        if filename.endswith('.json'):
            with open(filename, 'r') as f:
                return json.load(f)
        elif filename.endswith('.pkl'):
            with open(filename, 'rb') as f:
                return pickle.load(f)
        else:
            # Try JSON first
            with open(filename, 'r') as f:
                return json.load(f)
    except Exception as e:
        print(f"Error loading session: {e}")
        return None


def export_results(filename, data, format='txt'):
    """
    Export results to various formats
    
    Args:
        filename: Output filename
        data: Data to export
        format: Export format ('txt', 'csv', 'html')
        
    Returns:
        bool: True if successful
    """
    try:
        if format == 'txt':
            export_txt(filename, data)
        elif format == 'csv':
            export_csv(filename, data)
        elif format == 'html':
            export_html(filename, data)
        else:
            export_txt(filename, data)
            
        return True
    except Exception as e:
        print(f"Error exporting: {e}")
        return False


def export_txt(filename, data):
    """Export as text file"""
    with open(filename, 'w') as f:
        if isinstance(data, dict):
            for key, value in data.items():
                f.write(f"{key}: {value}\n")
        elif isinstance(data, list):
            for item in data:
                f.write(f"{item}\n")
        else:
            f.write(str(data))


def export_csv(filename, data):
    """Export as CSV file"""
    import csv
    
    with open(filename, 'w', newline='') as f:
        if isinstance(data, list) and len(data) > 0:
            # Assume list of dictionaries
            if isinstance(data[0], dict):
                writer = csv.DictWriter(f, fieldnames=data[0].keys())
                writer.writeheader()
                writer.writerows(data)
            else:
                writer = csv.writer(f)
                for item in data:
                    writer.writerow([item])
        elif isinstance(data, dict):
            writer = csv.writer(f)
            for key, value in data.items():
                writer.writerow([key, value])


def export_html(filename, data):
    """Export as HTML file"""
    html_template = """<!DOCTYPE html>
<html>
<head>
    <title>WiFi Pen Test Results</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 20px; }}
        h1 {{ color: #333; }}
        table {{ border-collapse: collapse; width: 100%; }}
        th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
        th {{ background-color: #4CAF50; color: white; }}
        tr:nth-child(even) {{ background-color: #f2f2f2; }}
    </style>
</head>
<body>
    <h1>WiFi Penetration Test Results</h1>
    <p>Generated: {timestamp}</p>
    <hr>
    {content}
</body>
</html>"""
    
    content = "<h2>Results</h2>\n"
    
    if isinstance(data, list) and len(data) > 0:
        if isinstance(data[0], dict):
            content += "<table>\n<tr>"
            for key in data[0].keys():
                content += f"<th>{key}</th>"
            content += "</tr>\n"
            
            for row in data:
                content += "<tr>"
                for value in row.values():
                    content += f"<td>{value}</td>"
                content += "</tr>\n"
            content += "</table>\n"
        else:
            content += "<ul>\n"
            for item in data:
                content += f"<li>{item}</li>\n"
            content += "</ul>\n"
    elif isinstance(data, dict):
        content += "<table>\n"
        for key, value in data.items():
            content += f"<tr><th>{key}</th><td>{value}</td></tr>\n"
        content += "</table>\n"
    else:
        content += f"<p>{data}</p>\n"
    
    html = html_template.format(
        timestamp=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        content=content
    )
    
    with open(filename, 'w') as f:
        f.write(html)


def ensure_directory(directory):
    """
    Ensure directory exists
    
    Args:
        directory: Directory path
        
    Returns:
        bool: True if directory exists or was created
    """
    try:
        os.makedirs(directory, exist_ok=True)
        return True
    except Exception:
        return False
