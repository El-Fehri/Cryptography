"""
Attack Control Panel Module
"""

import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import threading


class AttackPanel:
    """Attack control and monitoring panel"""
    
    def __init__(self, parent, main_window):
        self.parent = parent
        self.main = main_window
        
        self.current_target = None
        self.current_attack = None
        
        self.create_widgets()
        
    def create_widgets(self):
        """Create attack panel widgets"""
        # Notebook for different attack types
        self.notebook = ttk.Notebook(self.parent)
        self.notebook.pack(fill=tk.BOTH, expand=True)
        
        # Create tabs
        self.create_wep_tab()
        self.create_wpa_tab()
        self.create_deauth_tab()
        self.create_results_tab()
        
        # Target info frame (at bottom)
        self.create_target_info()
        
    def create_wep_tab(self):
        """Create WEP attacks tab"""
        wep_frame = ttk.Frame(self.notebook)
        self.notebook.add(wep_frame, text="WEP Attacks")
        
        # Attack selection
        attack_frame = ttk.LabelFrame(wep_frame, text="Attack Type", padding="5")
        attack_frame.pack(fill=tk.X, pady=5)
        
        self.wep_attack_var = tk.StringVar(value="fms")
        attacks = [
            ("FMS Attack", "fms", "Exploits weak IV patterns"),
            ("KoreK Attack", "korek", "Statistical attack with 16 IV classes"),
            ("Chop-Chop Attack", "chopchop", "Decrypts packet byte by byte"),
            ("Fragmentation Attack", "frag", "Obtains keystream fragments"),
            ("ARP Replay", "arp", "Generates new IVs by replaying ARP"),
        ]
        
        for text, value, tooltip in attacks:
            rb_frame = ttk.Frame(attack_frame)
            rb_frame.pack(anchor=tk.W, fill=tk.X)
            
            rb = ttk.Radiobutton(rb_frame, text=text, variable=self.wep_attack_var,
                                value=value)
            rb.pack(side=tk.LEFT)
            
            # Tooltip label
            ttk.Label(rb_frame, text=f"({tooltip})", 
                     foreground='gray').pack(side=tk.LEFT, padx=10)
        
        # Parameters frame
        param_frame = ttk.LabelFrame(wep_frame, text="Parameters", padding="5")
        param_frame.pack(fill=tk.X, pady=5)
        
        # Key length
        ttk.Label(param_frame, text="Key Length:").grid(row=0, column=0, sticky=tk.W, pady=2)
        self.key_length_var = tk.IntVar(value=104)
        ttk.Radiobutton(param_frame, text="40-bit", variable=self.key_length_var,
                       value=40).grid(row=0, column=1, sticky=tk.W)
        ttk.Radiobutton(param_frame, text="104-bit", variable=self.key_length_var,
                       value=104).grid(row=0, column=2, sticky=tk.W)
        
        # Packet count
        ttk.Label(param_frame, text="Packets to capture:").grid(row=1, column=0, sticky=tk.W, pady=2)
        self.packet_count_var = tk.IntVar(value=10000)
        packet_spin = ttk.Spinbox(param_frame, from_=100, to=1000000, 
                                  textvariable=self.packet_count_var, width=15)
        packet_spin.grid(row=1, column=1, columnspan=2, sticky=tk.W)
        
        # Control buttons
        btn_frame = ttk.Frame(wep_frame)
        btn_frame.pack(fill=tk.X, pady=10)
        
        self.launch_wep_btn = ttk.Button(btn_frame, text="ðŸš€ Launch Attack", 
                                         command=self.launch_wep_attack,
                                         style='Attack.TButton', width=20)
        self.launch_wep_btn.pack(side=tk.LEFT, padx=5)
        
        self.stop_wep_btn = ttk.Button(btn_frame, text="â¹ Stop", 
                                       command=self.stop_attack,
                                       style='Stop.TButton', state='disabled', width=10)
        self.stop_wep_btn.pack(side=tk.LEFT, padx=5)
        
        # Progress bar
        self.wep_progress = ttk.Progressbar(wep_frame, mode='determinate')
        self.wep_progress.pack(fill=tk.X, pady=5)
        
        # Progress label
        self.wep_progress_label = ttk.Label(wep_frame, text="Ready", style='Info.TLabel')
        self.wep_progress_label.pack()
        
    def create_wpa_tab(self):
        """Create WPA attacks tab"""
        wpa_frame = ttk.Frame(self.notebook)
        self.notebook.add(wpa_frame, text="WPA/WPA2 Attacks")
        
        # Attack selection
        attack_frame = ttk.LabelFrame(wpa_frame, text="Attack Type", padding="5")
        attack_frame.pack(fill=tk.X, pady=5)
        
        self.wpa_attack_var = tk.StringVar(value="handshake")
        attacks = [
            ("Capture 4-Way Handshake", "handshake", "Captures authentication handshake"),
            ("Dictionary Attack", "dictionary", "Brute-force with wordlist"),
            ("PMKID Attack", "pmkid", "Attacks RSN IE PMKID"),
            ("WPS Pixie Dust", "pixie", "Exploits weak WPS implementations"),
        ]
        
        for text, value, tooltip in attacks:
            rb_frame = ttk.Frame(attack_frame)
            rb_frame.pack(anchor=tk.W, fill=tk.X)
            
            ttk.Radiobutton(rb_frame, text=text, variable=self.wpa_attack_var,
                           value=value).pack(side=tk.LEFT)
            ttk.Label(rb_frame, text=f"({tooltip})", 
                     foreground='gray').pack(side=tk.LEFT, padx=10)
        
        # Wordlist selection
        wordlist_frame = ttk.LabelFrame(wpa_frame, text="Wordlist (for dictionary attack)", padding="5")
        wordlist_frame.pack(fill=tk.X, pady=5)
        
        file_frame = ttk.Frame(wordlist_frame)
        file_frame.pack(fill=tk.X)
        
        self.wordlist_entry = ttk.Entry(file_frame)
        self.wordlist_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0,5))
        self.wordlist_entry.insert(0, "/usr/share/wordlists/rockyou.txt")
        
        ttk.Button(file_frame, text="Browse", command=self.browse_wordlist).pack(side=tk.RIGHT)
        
        # Control buttons
        btn_frame = ttk.Frame(wpa_frame)
        btn_frame.pack(fill=tk.X, pady=10)
        
        self.launch_wpa_btn = ttk.Button(btn_frame, text="ðŸš€ Launch Attack",
                                         command=self.launch_wpa_attack,
                                         style='Attack.TButton', width=20)
        self.launch_wpa_btn.pack(side=tk.LEFT, padx=5)
        
        self.stop_wpa_btn = ttk.Button(btn_frame, text="â¹ Stop",
                                       command=self.stop_attack,
                                       style='Stop.TButton', state='disabled', width=10)
        self.stop_wpa_btn.pack(side=tk.LEFT, padx=5)
        
        # Progress
        self.wpa_progress = ttk.Progressbar(wpa_frame, mode='determinate')
        self.wpa_progress.pack(fill=tk.X, pady=5)
        
        self.wpa_progress_label = ttk.Label(wpa_frame, text="Ready", style='Info.TLabel')
        self.wpa_progress_label.pack()
        
    def create_deauth_tab(self):
        """Create deauthentication attack tab"""
        deauth_frame = ttk.Frame(self.notebook)
        self.notebook.add(deauth_frame, text="Deauth Attacks")
        
        # Target selection
        target_frame = ttk.LabelFrame(deauth_frame, text="Target", padding="5")
        target_frame.pack(fill=tk.X, pady=5)
        
        # BSSID
        ttk.Label(target_frame, text="BSSID:").grid(row=0, column=0, sticky=tk.W, pady=2)
        self.deauth_bssid = ttk.Entry(target_frame, width=20)
        self.deauth_bssid.grid(row=0, column=1, padx=5, pady=2)
        
        # Client MAC
        ttk.Label(target_frame, text="Client MAC:").grid(row=1, column=0, sticky=tk.W, pady=2)
        self.deauth_client = ttk.Entry(target_frame, width=20)
        self.deauth_client.grid(row=1, column=1, padx=5, pady=2)
        self.deauth_client.insert(0, "FF:FF:FF:FF:FF:FF")
        
        # Use selected client button
        ttk.Button(target_frame, text="Use Selected Client", 
                  command=self.use_selected_client).grid(row=1, column=2, padx=5)
        
        # Parameters
        param_frame = ttk.LabelFrame(deauth_frame, text="Parameters", padding="5")
        param_frame.pack(fill=tk.X, pady=5)
        
        # Packet count
        ttk.Label(param_frame, text="Number of packets:").grid(row=0, column=0, sticky=tk.W, pady=2)
        self.deauth_count = ttk.Spinbox(param_frame, from_=1, to=1000, width=15)
        self.deauth_count.set(10)
        self.deauth_count.grid(row=0, column=1, sticky=tk.W)
        
        # Delay
        ttk.Label(param_frame, text="Delay (ms):").grid(row=1, column=0, sticky=tk.W, pady=2)
        self.deauth_delay = ttk.Spinbox(param_frame, from_=0, to=1000, width=15)
        self.deauth_delay.set(100)
        self.deauth_delay.grid(row=1, column=1, sticky=tk.W)
        
        # Reason code
        ttk.Label(param_frame, text="Reason code:").grid(row=2, column=0, sticky=tk.W, pady=2)
        self.deauth_reason = ttk.Combobox(param_frame, values=[
            "1 - Unspecified",
            "2 - Previous auth invalid",
            "3 - Station leaving",
            "4 - Inactivity",
            "5 - AP unable to handle",
            "7 - Nonassociated station"
        ], width=25)
        self.deauth_reason.set("1 - Unspecified")
        self.deauth_reason.grid(row=2, column=1, columnspan=2, sticky=tk.W)
        
        # Control buttons
        btn_frame = ttk.Frame(deauth_frame)
        btn_frame.pack(fill=tk.X, pady=10)
        
        self.launch_deauth_btn = ttk.Button(btn_frame, text="ðŸš€ Launch Deauth",
                                            command=self.launch_deauth,
                                            style='Attack.TButton', width=20)
        self.launch_deauth_btn.pack(side=tk.LEFT, padx=5)
        
        self.stop_deauth_btn = ttk.Button(btn_frame, text="â¹ Stop",
                                          command=self.stop_attack,
                                          style='Stop.TButton', state='disabled', width=10)
        self.stop_deauth_btn.pack(side=tk.LEFT, padx=5)
        
        # Status
        self.deauth_status = ttk.Label(deauth_frame, text="Packets sent: 0", style='Info.TLabel')
        self.deauth_status.pack(pady=5)
        
        # Progress
        self.deauth_progress = ttk.Progressbar(deauth_frame, mode='determinate')
        self.deauth_progress.pack(fill=tk.X, pady=5)
        
    def create_results_tab(self):
        """Create results display tab"""
        results_frame = ttk.Frame(self.notebook)
        self.notebook.add(results_frame, text="Results & Log")
        
        # Results text area
        self.results_text = scrolledtext.ScrolledText(results_frame, wrap=tk.WORD,
                                                      font=('Courier', 9))
        self.results_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        # Configure tags for colored output
        self.results_text.tag_configure('success', foreground='#629755')
        self.results_text.tag_configure('error', foreground='#b54a4a')
        self.results_text.tag_configure('warning', foreground='#c77d4a')
        self.results_text.tag_configure('info', foreground='#589df6')
        self.results_text.tag_configure('header', foreground='#ffffff', font=('Courier', 9, 'bold'))
        
        # Buttons
        btn_frame = ttk.Frame(results_frame)
        btn_frame.pack(fill=tk.X, pady=5)
        
        ttk.Button(btn_frame, text="Clear Results", 
                  command=self.clear_results).pack(side=tk.LEFT, padx=2)
        ttk.Button(btn_frame, text="Copy to Clipboard", 
                  command=self.copy_results).pack(side=tk.LEFT, padx=2)
        ttk.Button(btn_frame, text="Save Results", 
                  command=self.save_results).pack(side=tk.LEFT, padx=2)
        
    def create_target_info(self):
        """Create target information frame"""
        target_frame = ttk.LabelFrame(self.parent, text="Current Target", padding="5")
        target_frame.pack(fill=tk.X, pady=5)
        
        # Target info display
        info_frame = ttk.Frame(target_frame)
        info_frame.pack(fill=tk.X)
        
        ttk.Label(info_frame, text="BSSID:", font=('Arial', 9, 'bold')).grid(row=0, column=0, sticky=tk.W)
        self.target_bssid = ttk.Label(info_frame, text="None", style='Info.TLabel')
        self.target_bssid.grid(row=0, column=1, sticky=tk.W, padx=5)
        
        ttk.Label(info_frame, text="SSID:", font=('Arial', 9, 'bold')).grid(row=0, column=2, sticky=tk.W, padx=(20,0))
        self.target_ssid = ttk.Label(info_frame, text="None", style='Info.TLabel')
        self.target_ssid.grid(row=0, column=3, sticky=tk.W, padx=5)
        
        ttk.Label(info_frame, text="Encryption:", font=('Arial', 9, 'bold')).grid(row=0, column=4, sticky=tk.W, padx=(20,0))
        self.target_enc = ttk.Label(info_frame, text="None", style='Info.TLabel')
        self.target_enc.grid(row=0, column=5, sticky=tk.W, padx=5)
        
    def set_target(self, bssid, ssid, encryption):
        """Set current target"""
        self.current_target = {
            'bssid': bssid,
            'ssid': ssid,
            'encryption': encryption
        }
        if hasattr(self, 'target_bssid'):
            self.target_bssid.config(text=bssid)
        if hasattr(self, 'target_ssid'):
            self.target_ssid.config(text=ssid)
        if hasattr(self, 'target_enc'):
            self.target_enc.config(text=encryption)
        
    def launch_wep_attack(self):
        """Launch selected WEP attack"""
        if not self.current_target:
            messagebox.showwarning("No Target", "Please select a target network first")
            return
            
        attack_type = self.wep_attack_var.get()
        
        # Update UI
        self.launch_wep_btn.config(state='disabled')
        self.stop_wep_btn.config(state='normal')
        self.wep_progress['value'] = 0
        self.wep_progress_label.config(text=f"Starting {attack_type} attack...")
        
        # Clear previous results
        self.add_result("=" * 60, 'header')
        self.add_result(f"Starting {attack_type.upper()} attack on {self.current_target['ssid']}", 'header')
        self.add_result("=" * 60, 'header')
        
        # Launch attack in thread
        def run_attack():
            self.main.wep_attack.set_status_callback(self.attack_callback)
            self.main.wep_attack.start(
                attack_type=attack_type,
                target_bssid=self.current_target['bssid'],
                key_length=self.key_length_var.get(),
                min_packets=self.packet_count_var.get()
            )
            
        threading.Thread(target=run_attack, daemon=True).start()
        
    def launch_wpa_attack(self):
        """Launch selected WPA attack"""
        if not self.current_target:
            messagebox.showwarning("No Target", "Please select a target network first")
            return
            
        attack_type = self.wpa_attack_var.get()
        
        self.launch_wpa_btn.config(state='disabled')
        self.stop_wpa_btn.config(state='normal')
        self.wpa_progress['value'] = 0
        
        self.add_result("=" * 60, 'header')
        self.add_result(f"Starting {attack_type} attack on {self.current_target['ssid']}", 'header')
        self.add_result("=" * 60, 'header')
        
        def run_attack():
            self.main.wpa_attack.set_status_callback(self.attack_callback)
            self.main.wpa_attack.start(
                attack_type=attack_type,
                target_bssid=self.current_target['bssid']
            )
            
        threading.Thread(target=run_attack, daemon=True).start()
        
    def launch_deauth(self):
        """Launch deauthentication attack"""
        if not self.deauth_bssid.get() and not self.current_target:
            messagebox.showwarning("No Target", "Please enter a BSSID or select a target")
            return
            
        bssid = self.deauth_bssid.get() or (self.current_target['bssid'] if self.current_target else '')
        client = self.deauth_client.get()
        count = int(self.deauth_count.get())
        delay = int(self.deauth_delay.get()) / 1000.0  # Convert to seconds
        
        self.launch_deauth_btn.config(state='disabled')
        self.stop_deauth_btn.config(state='normal')
        
        self.add_result("=" * 60, 'header')
        self.add_result(f"Starting deauth attack on {bssid} -> {client}", 'header')
        self.add_result("=" * 60, 'header')
        
        def run_attack():
            self.main.deauth_attack.set_status_callback(self.attack_callback)
            self.main.deauth_attack.start(
                target_bssid=bssid,
                client_mac=client,
                count=count,
                delay=delay
            )
            
        threading.Thread(target=run_attack, daemon=True).start()
        
    def attack_callback(self, result):
        """Callback for attack results"""
        self.main.message_queue.put({
            'type': 'attack_result',
            'data': result
        })
        
    def add_result(self, result, tag='info'):
        """Add result to results tab"""
        if isinstance(result, dict):
            # Format dictionary result
            if 'type' in result:
                if 'success' in result['type'] or 'complete' in result['type']:
                    tag = 'success'
                elif 'error' in result['type']:
                    tag = 'error'
                elif 'warning' in result['type']:
                    tag = 'warning'
                    
            # Format the result
            text = f"[{result.get('type', 'info')}] "
            for key, value in result.items():
                if key != 'type' and key != 'timestamp':
                    text += f"{key}: {value} "
            self.results_text.insert(tk.END, text + "\n", tag)
        else:
            # Plain text result
            self.results_text.insert(tk.END, str(result) + "\n", tag)
            
        # Auto-scroll
        self.results_text.see(tk.END)
        
        # Update progress if available
        if isinstance(result, dict):
            if 'progress' in result:
                self.update_progress(result['progress'])
                
    def add_to_log(self, message):
        """Add message to log display"""
        if hasattr(self, 'results_text'):
            try:
                self.results_text.insert(tk.END, message + "\n")
                self.results_text.see(tk.END)
            except:
                pass
        
    def update_progress(self, value):
        """Update progress bars"""
        current_tab = self.notebook.select()
        tab_text = self.notebook.tab(current_tab, "text")
        
        if "WEP" in tab_text:
            self.wep_progress['value'] = value
            self.wep_progress_label.config(text=f"Progress: {value:.1f}%")
        elif "WPA" in tab_text:
            self.wpa_progress['value'] = value
            self.wpa_progress_label.config(text=f"Progress: {value:.1f}%")
        elif "Deauth" in tab_text:
            self.deauth_progress['value'] = value
            self.deauth_status.config(text=f"Packets sent: {int(value)}")
            
    def stop_attack(self):
        """Stop current attack"""
        # Stop all attacks
        self.main.wep_attack.stop()
        self.main.wpa_attack.stop()
        self.main.deauth_attack.stop()
        
        # Reset UI
        self.launch_wep_btn.config(state='normal')
        self.launch_wpa_btn.config(state='normal')
        self.launch_deauth_btn.config(state='normal')
        self.stop_wep_btn.config(state='disabled')
        self.stop_wpa_btn.config(state='disabled')
        self.stop_deauth_btn.config(state='disabled')
        
        self.add_result("Attack stopped by user", 'warning')
        self.main.update_status({'attack': 'Stopped'})
        
    def browse_wordlist(self):
        """Browse for wordlist file"""
        from tkinter import filedialog
        filename = filedialog.askopenfilename(
            title="Select Wordlist",
            filetypes=[("Text files", "*.txt"), ("All files", "*.*")]
        )
        if filename:
            self.wordlist_entry.delete(0, tk.END)
            self.wordlist_entry.insert(0, filename)
            
    def use_selected_client(self):
        """Use client selected in network panel"""
        selection = self.main.network_panel.client_tree.selection()
        if selection:
            item = self.main.network_panel.client_tree.item(selection[0])
            values = item['values']
            if values:
                self.deauth_client.delete(0, tk.END)
                self.deauth_client.insert(0, values[0])
                
    def clear_results(self):
        """Clear results text"""
        self.results_text.delete(1.0, tk.END)
        
    def copy_results(self):
        """Copy results to clipboard"""
        text = self.results_text.get(1.0, tk.END)
        self.parent.clipboard_clear()
        self.parent.clipboard_append(text)
        
    def save_results(self):
        """Save results to file"""
        from tkinter import filedialog
        filename = filedialog.asksaveasfilename(
            title="Save Results",
            defaultextension=".txt",
            filetypes=[("Text files", "*.txt"), ("All files", "*.*")]
        )
        if filename:
            try:
                with open(filename, 'w') as f:
                    f.write(self.results_text.get(1.0, tk.END))
                self.add_result(f"Results saved to {filename}", 'success')
            except Exception as e:
                messagebox.showerror("Error", f"Failed to save: {str(e)}")
                
    def clear_all(self):
        """Clear all panel data"""
        self.clear_results()
        self.set_target("None", "None", "None")
